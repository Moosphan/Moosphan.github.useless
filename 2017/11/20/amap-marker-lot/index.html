<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Android基于高德地图实现Marker聚合效果 - Hulk</title><meta description="最近,项目有了新的需求,要求地图上的标签点实现聚合效果,单纯的marker已经无法满足大量数据展示的情况,聚合效果成为大势所趋。 目前,网上提供基于高德marker聚合的思路大致差不多,处于雏形阶段。高德官方也提供了关于聚合的解决方案,对于缓存和加载效率都做了一些处理,为我们后面的定制奠定了基础,本文就在高德官方提供的方案基础上做一些定制化。笔者经过思考后,还是觉得将篇幅分为上下两部分,前篇主要涉"><meta property="og:type" content="blog"><meta property="og:title" content="Android基于高德地图实现Marker聚合效果"><meta property="og:url" content="https://moosphan.github.io/2017/11/20/amap-marker-lot/"><meta property="og:site_name" content="Hulk"><meta property="og:description" content="最近,项目有了新的需求,要求地图上的标签点实现聚合效果,单纯的marker已经无法满足大量数据展示的情况,聚合效果成为大势所趋。 目前,网上提供基于高德marker聚合的思路大致差不多,处于雏形阶段。高德官方也提供了关于聚合的解决方案,对于缓存和加载效率都做了一些处理,为我们后面的定制奠定了基础,本文就在高德官方提供的方案基础上做一些定制化。笔者经过思考后,还是觉得将篇幅分为上下两部分,前篇主要涉"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5256969-346e7530823447b6.jpg?imageMogr2/auto-orient/strip"><meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5256969-0d434a7340359c3f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="article:published_time" content="2017-11-20T14:35:15.000Z"><meta property="article:modified_time" content="2020-08-20T12:31:34.804Z"><meta property="article:author" content="Hulk"><meta property="article:tag" content="高德地图"><meta property="article:tag" content="Marker聚合"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="http://upload-images.jianshu.io/upload_images/5256969-346e7530823447b6.jpg?imageMogr2/auto-orient/strip"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://moosphan.github.io/2017/11/20/amap-marker-lot/"},"headline":"Hulk","image":[],"datePublished":"2017-11-20T14:35:15.000Z","dateModified":"2020-08-20T12:31:34.804Z","author":{"@type":"Person","name":"Hulk"},"description":"最近,项目有了新的需求,要求地图上的标签点实现聚合效果,单纯的marker已经无法满足大量数据展示的情况,聚合效果成为大势所趋。 目前,网上提供基于高德marker聚合的思路大致差不多,处于雏形阶段。高德官方也提供了关于聚合的解决方案,对于缓存和加载效率都做了一些处理,为我们后面的定制奠定了基础,本文就在高德官方提供的方案基础上做一些定制化。笔者经过思考后,还是觉得将篇幅分为上下两部分,前篇主要涉"}</script><link rel="canonical" href="https://moosphan.github.io/2017/11/20/amap-marker-lot/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Hulk" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/archives">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2017-11-20T14:35:15.000Z" title="2017-11-20T14:35:15.000Z">2017-11-20</time><span class="level-item"><a class="link-muted" href="/categories/Android/">Android</a><span> / </span><a class="link-muted" href="/categories/Android/%E5%9C%B0%E5%9B%BE%E5%BC%80%E5%8F%91/">地图开发</a></span><span class="level-item">27 分钟 读完 (大约 4064 个字)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Android基于高德地图实现Marker聚合效果</h1><div class="content"><p>最近,项目有了新的需求,要求地图上的标签点实现聚合效果,单纯的marker已经无法满足大量数据展示的情况,聚合效果成为大势所趋。</p>
<p>目前,网上提供基于高德marker聚合的思路大致差不多,处于雏形阶段。高德官方也提供了关于聚合的解决方案,对于缓存和加载效率都做了一些处理,为我们后面的定制奠定了基础,本文就在高德官方提供的方案基础上做一些定制化。笔者经过思考后,还是觉得将篇幅分为上下两部分,前篇主要涉及聚合的基本使用以及针对定制过程中出现的坑进行填补(如多种聚合标签的冲突,聚合标签与普通标签的冲突问题等),下篇则讲述如何定制化marker并加载网络图片(为了方便描述,marker聚合在下文都称之为聚合标签)。看完两篇文章,大家还可以尝试将聚合和网络图片样式的marker结合起来,达到更加炫酷的效果。<br>话不多说,先来看看最终的效果吧:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5256969-346e7530823447b6.jpg?imageMogr2/auto-orient/strip" alt="效果图"></p>
<p>先来放一下官网提供的聚合点的demo:<a href="https://github.com/amap-demo/android-cluster-marker">https://github.com/amap-demo/android-cluster-marker</a><br>,如果只是实现一种聚合点,可以复制官方的demo代码,稍微改改就可以用了。如果你们产品有其他需求,比如多种聚合标签点,或者实现普通标签和聚合标签的混排使用,那么可以参考下本文提供的改进思路。<a id="more"></a></p>
<ul>
<li>发现问题:</li>
</ul>
<p>首先,我们发现高德官方提供的demo存在的问题:</p>
<ol>
<li>当存在多种类型聚合标签点时,聚合点的点击事件冲突问题.<blockquote>
<p>这个问题是什么意思呢?举个例子:当地图上我们先后初始化两种聚合标签点A和B的时候,不管点击A还是B类型的聚合点,都会只响应B类的点击事件,即先声明的聚合标签的点击事件会被后声明的聚合标签的点击事件”抢占”.</p>
</blockquote>
</li>
<li>当地图上存在普通标签(Marker)和聚合标签(Cluster)时,同样会产生点击事件的冲突问题.<blockquote>
<p>这个意思就是,点击聚合标签仍然会响应普通标签的点击事件.</p>
</blockquote>
</li>
</ol>
<ul>
<li><p>分析问题:</p>
<blockquote>
<p>这两个问题其实归根结底是一个问题,都是因为marker的点击事件被抢占,从官方的提供的ClusterOverlay类中代码我们就可以看出来:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">amap.setOnCameraChangeListener(this);</span><br><span class="line">amap.setOnMarkerClickListener(this);</span><br><span class="line">......</span><br><span class="line"> &#x2F;&#x2F;点击事件</span><br><span class="line">    @Override</span><br><span class="line">    public boolean onMarkerClick(Marker arg0) &#123;</span><br><span class="line">        if (mClusterClickListener &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">       Cluster cluster&#x3D; (Cluster) arg0.getObject();</span><br><span class="line">        if(cluster!&#x3D;null)&#123;</span><br><span class="line">            mClusterClickListener.onClick(arg0,cluster.getClusterItems());</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;从以上代码我们可以看出来,聚合处理类ClusterOverlay实现了AMap.OnMarkerClickListener接口,而当我们使用两个或者两个以上样式的聚合标签时,我们就会发现明明是两种类型的聚合标签,但是却触发相同的点击事件。这样显然是不符合我们预期需求的,那么我们该如何让不同样式的聚合标签A,B,C…各司其职呢?你肯定会说,废话,不然你现在在讲啥!咳咳,请允许我静静~ </p>
</li>
<li><p>解决问题:</p>
</li>
</ul>
<p>&emsp;&emsp;显然,如果我们想让各种聚合标签互不干扰,需要集中管理它们的点击事件,即OnMarkerClickListener。假设我们写了两个不同的聚合标签类ClusterOverlayA和ClusterOverlayB,我们可以将两个类中OnMarkerClick()方法中的逻辑拿出来,单独封装成一个方法,然后放在我们Activity的onMarkerClick()中执行.这里我贴一下修改后的ClusterOverlay类,前方高能,一大波代码来袭:</p>
<blockquote>
<p>ClusterOverlay:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Created by yiyi.qi on 16&#x2F;10&#x2F;10.</span><br><span class="line"> * 整体设计采用了两个线程,一个线程用于计算组织聚合数据,一个线程负责处理Marker相关操作</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class ClusterOverlay &#123;</span><br><span class="line">    private AMap mAMap;</span><br><span class="line">    private Context mContext;</span><br><span class="line">    private List&lt;ClusterItem&gt; mClusterItems;</span><br><span class="line">    private List&lt;Cluster&gt; mClusters;</span><br><span class="line">    private int mClusterSize;</span><br><span class="line">    private ClusterClickListener mClusterClickListener;</span><br><span class="line">    private ClusterRender mClusterRender;</span><br><span class="line">    private ClusterRenderB bClusterRender;</span><br><span class="line">    private AMap.OnMarkerClickListener markerClickListener&#x3D;new AMap.OnMarkerClickListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean onMarkerClick(Marker arg0) &#123;</span><br><span class="line">            if (mClusterClickListener &#x3D;&#x3D; null) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            Cluster cluster &#x3D; (Cluster) arg0.getObject();</span><br><span class="line">            &#x2F;&#x2F;将marker的位置移动到地图中心</span><br><span class="line">            LatLng latLng&#x3D;new LatLng(arg0.getPosition().latitude,arg0.getPosition().longitude);</span><br><span class="line">            mAMap.moveCamera(CameraUpdateFactory.changeLatLng(latLng));</span><br><span class="line">            if (cluster !&#x3D; null) &#123;</span><br><span class="line">                arg0.showInfoWindow();</span><br><span class="line">                Log.e(&quot;timeory&quot;, &quot;普通标签infowindow出现了吗?  &quot; +  arg0.isInfoWindowShown()+ &quot;   &quot;+ arg0.isInfoWindowEnable(), null);</span><br><span class="line">                mClusterClickListener.onClick(arg0, cluster.getClusterItems());</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private List&lt;Marker&gt; mAddMarkers &#x3D; new ArrayList&lt;Marker&gt;();</span><br><span class="line">    private double mClusterDistance;</span><br><span class="line">    private LruCache&lt;Integer, BitmapDescriptor&gt; mLruCache;</span><br><span class="line">    private HandlerThread mMarkerHandlerThread &#x3D; new HandlerThread(&quot;addMarker&quot;);</span><br><span class="line">    private HandlerThread mSignClusterThread &#x3D; new HandlerThread(&quot;calculateCluster&quot;);</span><br><span class="line">    private Handler mMarkerhandler;</span><br><span class="line">    private Handler mSignClusterHandler;</span><br><span class="line">    private float mPXInMeters;</span><br><span class="line">    private boolean mIsCanceled &#x3D; false;</span><br><span class="line">    private MarkerOptions markerOptions;</span><br><span class="line">    private Cluster mcluster;</span><br><span class="line">    private LatLng latlng1;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 构造函数</span><br><span class="line">     *</span><br><span class="line">     * @param amap</span><br><span class="line">     * @param clusterSize 聚合范围的大小（指点像素单位距离内的点会聚合到一个点显示）</span><br><span class="line">     * @param context</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public ClusterOverlay(AMap amap, int clusterSize, Context context) &#123;</span><br><span class="line">        this(amap, null, clusterSize, context);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 构造函数,批量添加聚合元素时,调用此构造函数</span><br><span class="line">     *  默认最多会缓存80张图片作为聚合显示元素图片,根据自己显示需求和app使用内存情况,可以修改数量</span><br><span class="line">     * @param amap</span><br><span class="line">     * @param clusterItems 聚合元素</span><br><span class="line">     * @param clusterSize</span><br><span class="line">     * @param context</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public ClusterOverlay(AMap amap, List&lt;ClusterItem&gt; clusterItems, int clusterSize, Context context) &#123;</span><br><span class="line">        mLruCache &#x3D; new LruCache&lt;Integer, BitmapDescriptor&gt;(80) &#123;</span><br><span class="line">            protected void entryRemoved(boolean evicted, Integer key, BitmapDescriptor oldValue, BitmapDescriptor newValue) &#123;</span><br><span class="line">                oldValue.getBitmap().recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        if (clusterItems !&#x3D; null) &#123;</span><br><span class="line">            mClusterItems &#x3D; clusterItems;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mClusterItems &#x3D; new ArrayList&lt;ClusterItem&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mContext &#x3D; context;</span><br><span class="line">        mClusters &#x3D; new ArrayList&lt;Cluster&gt;();</span><br><span class="line">        this.mAMap &#x3D; amap;</span><br><span class="line">        mClusterSize &#x3D; clusterSize;</span><br><span class="line">        mPXInMeters &#x3D; mAMap.getScalePerPixel();</span><br><span class="line">        mClusterDistance &#x3D; mPXInMeters * mClusterSize;</span><br><span class="line">        initThreadHandler();</span><br><span class="line">        assignClusters();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * by moos on 2017&#x2F;11&#x2F;13</span><br><span class="line">     * function:聚合刷新,在activity的onCameraChangeFinish()方法中</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void updateClusters()&#123;</span><br><span class="line">        mPXInMeters &#x3D; mAMap.getScalePerPixel();</span><br><span class="line">        mClusterDistance &#x3D; mPXInMeters * mClusterSize;</span><br><span class="line">        assignClusters();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * by moos on 2017&#x2F;11&#x2F;13</span><br><span class="line">     * func:通过activity中的onMarkerClick()响应聚合点的点击事件</span><br><span class="line">     * @param arg0</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void respondClusterClickEvent(Marker arg0)&#123;</span><br><span class="line"></span><br><span class="line">        Cluster cluster &#x3D; (Cluster) arg0.getObject();</span><br><span class="line">        &#x2F;&#x2F;将marker的位置移动到地图中心</span><br><span class="line">        LatLng latLng&#x3D;new LatLng(arg0.getPosition().latitude,arg0.getPosition().longitude);</span><br><span class="line">        mAMap.moveCamera(CameraUpdateFactory.changeLatLng(latLng));</span><br><span class="line">        if (cluster !&#x3D; null) &#123;</span><br><span class="line">            arg0.showInfoWindow();</span><br><span class="line">            Log.e(&quot;timeory&quot;, &quot;普通标签infowindow出现了吗?  &quot; +  arg0.isInfoWindowShown()+ &quot;   &quot;+ arg0.isInfoWindowEnable(), null);</span><br><span class="line">            mClusterClickListener.onClick(arg0, cluster.getClusterItems());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 设置聚合点的点击事件</span><br><span class="line">     *</span><br><span class="line">     * @param clusterClickListener</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void setOnClusterClickListener(ClusterClickListener clusterClickListener) &#123;</span><br><span class="line">        mClusterClickListener &#x3D; clusterClickListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 添加一个聚合点</span><br><span class="line">     *</span><br><span class="line">     * @param item</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void addClusterItem(ClusterItem item) &#123;</span><br><span class="line">        Message message &#x3D; Message.obtain();</span><br><span class="line">        message.what &#x3D; SignClusterHandler.CALCULATE_SINGLE_CLUSTER;</span><br><span class="line">        message.obj &#x3D; item;</span><br><span class="line">        mSignClusterHandler.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 共外部调用的接口,设置聚合元素的渲染样式，不设置则默认为气泡加数字形式进行渲染</span><br><span class="line">     *</span><br><span class="line">     * @param render</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void setClusterRenderer(ClusterRender render) &#123;</span><br><span class="line">        mClusterRender &#x3D; render;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 设置聚合元素的渲染样式，不设置则默认为气泡加数字形式进行渲染</span><br><span class="line">     *</span><br><span class="line">     * @param render</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void setBClusterRenderer(ClusterRenderB render) &#123;</span><br><span class="line">        bClusterRender &#x3D; render;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onDestroy() &#123;</span><br><span class="line">        mIsCanceled &#x3D; true;</span><br><span class="line">        mSignClusterHandler.removeCallbacksAndMessages(null);</span><br><span class="line">        mMarkerhandler.removeCallbacksAndMessages(null);</span><br><span class="line">        mSignClusterThread.quit();</span><br><span class="line">        mMarkerHandlerThread.quit();</span><br><span class="line">        for (Marker marker : mAddMarkers) &#123;</span><br><span class="line">            marker.remove();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        if(markerClickListener!&#x3D;null)&#123;</span><br><span class="line">            markerClickListener &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        mAddMarkers.clear();</span><br><span class="line">        mLruCache.evictAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 清除maker点击事件,防止抢占</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void cleanListener()&#123;</span><br><span class="line">        if(markerClickListener!&#x3D;null)&#123;</span><br><span class="line">            markerClickListener &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化Handler</span><br><span class="line">    private void initThreadHandler() &#123;</span><br><span class="line">        mMarkerHandlerThread.start();</span><br><span class="line">        mSignClusterThread.start();</span><br><span class="line">        mMarkerhandler &#x3D; new MarkerHandler(mMarkerHandlerThread.getLooper());</span><br><span class="line">        mSignClusterHandler &#x3D; new SignClusterHandler(mSignClusterThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 将聚合元素添加至地图上</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private void addClusterToMap(List&lt;Cluster&gt; clusters) &#123;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Marker&gt; removeMarkers &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">        removeMarkers.addAll(mAddMarkers);</span><br><span class="line">        AlphaAnimation alphaAnimation &#x3D; new AlphaAnimation(1, 0);</span><br><span class="line">        MyAnimationListener myAnimationListener &#x3D; new MyAnimationListener(removeMarkers);</span><br><span class="line">        for (Marker marker : removeMarkers) &#123;</span><br><span class="line">            marker.setAnimation(alphaAnimation);</span><br><span class="line">            marker.setAnimationListener(myAnimationListener);</span><br><span class="line">            marker.startAnimation();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (Cluster cluster : clusters) &#123;</span><br><span class="line">            addSingleClusterToMap(cluster);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private AlphaAnimation mADDAnimation &#x3D; new AlphaAnimation(0, 1);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 将单个聚合元素添加至地图显示</span><br><span class="line">     *</span><br><span class="line">     * @param cluster</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private void addSingleClusterToMap(Cluster cluster) &#123;</span><br><span class="line">        latlng1 &#x3D; cluster.getCenterLatLng();</span><br><span class="line">        markerOptions &#x3D; new MarkerOptions();</span><br><span class="line">        markerOptions</span><br><span class="line">                .anchor(0.5f, 0.5f)</span><br><span class="line">                .icon(getBitmapDes(cluster.getClusterCount()))</span><br><span class="line">                .position(latlng1);</span><br><span class="line">        Marker marker &#x3D; mAMap.addMarker(markerOptions);</span><br><span class="line">        marker.setAnimation(mADDAnimation);</span><br><span class="line">        marker.setObject(cluster);</span><br><span class="line">        marker.startAnimation();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        marker.setTitle(&quot;你好啊&quot;);</span><br><span class="line">&#x2F;&#x2F;        marker.setSnippet(&quot;真的不好&quot;);</span><br><span class="line">        cluster.setMarker(marker);</span><br><span class="line">        mcluster &#x3D; cluster;</span><br><span class="line">        mAddMarkers.add(marker);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void newIcon() &#123;</span><br><span class="line">        markerOptions</span><br><span class="line">                .anchor(0.5f, 0.5f)</span><br><span class="line">                .icon(getBitmapDes(mcluster.getClusterCount()))</span><br><span class="line">                .position(latlng1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private void calculateClusters() &#123;</span><br><span class="line">        mIsCanceled &#x3D; false;</span><br><span class="line">        mClusters.clear();</span><br><span class="line">        &#x2F;&#x2F;地图获取转换器, 获取可视区域, 获取可视区域的四个点形成的经纬度范围, 得到一个经纬度范围</span><br><span class="line">        LatLngBounds visibleBounds &#x3D; mAMap.getProjection().getVisibleRegion().latLngBounds;</span><br><span class="line">        for (ClusterItem clusterItem : mClusterItems) &#123;</span><br><span class="line">            if (mIsCanceled) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            LatLng latlng &#x3D; clusterItem.getPosition();&#x2F;&#x2F;聚合元素的地理位置</span><br><span class="line">            if (visibleBounds.contains(latlng)) &#123;&#x2F;&#x2F;如果这个范围包含这个聚合元素的地理位置</span><br><span class="line">                Cluster cluster &#x3D; getCluster(latlng, mClusters);&#x2F;&#x2F;根据这个位置和聚合物的集合, 获得一个聚合器</span><br><span class="line">                if (cluster !&#x3D; null) &#123;</span><br><span class="line">                    cluster.addClusterItem(clusterItem);&#x2F;&#x2F;往聚合器中添加聚合点</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    cluster &#x3D; new Cluster(latlng);</span><br><span class="line">                    mClusters.add(cluster);</span><br><span class="line">                    cluster.addClusterItem(clusterItem);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;复制一份数据，规避同步</span><br><span class="line">        List&lt;Cluster&gt; clusters &#x3D; new ArrayList&lt;Cluster&gt;();</span><br><span class="line">        clusters.addAll(mClusters);</span><br><span class="line">        Message message &#x3D; Message.obtain();</span><br><span class="line">        message.what &#x3D; MarkerHandler.ADD_CLUSTER_LIST;</span><br><span class="line">        message.obj &#x3D; clusters;</span><br><span class="line">        if (mIsCanceled) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        mMarkerhandler.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 对点进行聚合</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private void assignClusters() &#123;</span><br><span class="line">        mIsCanceled &#x3D; true;</span><br><span class="line">        mSignClusterHandler.removeMessages(SignClusterHandler.CALCULATE_CLUSTER);</span><br><span class="line">        mSignClusterHandler.sendEmptyMessage(SignClusterHandler.CALCULATE_CLUSTER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 在已有的聚合基础上，对添加的单个元素进行聚合</span><br><span class="line">     *</span><br><span class="line">     * @param clusterItem</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private void calculateSingleCluster(ClusterItem clusterItem) &#123;</span><br><span class="line">        LatLngBounds visibleBounds &#x3D; mAMap.getProjection().getVisibleRegion().latLngBounds;</span><br><span class="line">        LatLng latlng &#x3D; clusterItem.getPosition();</span><br><span class="line">        if (!visibleBounds.contains(latlng)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        Cluster cluster &#x3D; getCluster(latlng, mClusters);</span><br><span class="line">        if (cluster !&#x3D; null) &#123;</span><br><span class="line">            cluster.addClusterItem(clusterItem);</span><br><span class="line">            Message message &#x3D; Message.obtain();</span><br><span class="line">            message.what &#x3D; MarkerHandler.UPDATE_SINGLE_CLUSTER;</span><br><span class="line"></span><br><span class="line">            message.obj &#x3D; cluster;</span><br><span class="line">            mMarkerhandler.removeMessages(MarkerHandler.UPDATE_SINGLE_CLUSTER);</span><br><span class="line">            mMarkerhandler.sendMessageDelayed(message, 5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line"></span><br><span class="line">            cluster &#x3D; new Cluster(latlng);</span><br><span class="line">            mClusters.add(cluster);</span><br><span class="line">            cluster.addClusterItem(clusterItem);</span><br><span class="line">            Message message &#x3D; Message.obtain();</span><br><span class="line">            message.what &#x3D; MarkerHandler.ADD_SINGLE_CLUSTER;</span><br><span class="line">            message.obj &#x3D; cluster;</span><br><span class="line">            mMarkerhandler.sendMessage(message);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 根据一个点获取是否可以依附的聚合点，没有则返回null</span><br><span class="line">     *</span><br><span class="line">     * @param latLng</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private Cluster getCluster(LatLng latLng, List&lt;Cluster&gt; clusters) &#123;</span><br><span class="line">        for (Cluster cluster : clusters) &#123;</span><br><span class="line">            LatLng clusterCenterPoint &#x3D; cluster.getCenterLatLng();</span><br><span class="line">            double distance &#x3D; AMapUtils.calculateLineDistance(latLng, clusterCenterPoint);</span><br><span class="line">            if (distance &lt; mClusterDistance) &#123;</span><br><span class="line">                return cluster;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取每个聚合点的绘制样式</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private BitmapDescriptor getBitmapDes(int num) &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;加载字体</span><br><span class="line">        Typeface typeFace &#x3D; Typeface.createFromAsset(mContext.getAssets(), &quot;fonts&#x2F;A-OTF-ShinGoPr6N-Ultra.otf&quot;);</span><br><span class="line"></span><br><span class="line">        BitmapDescriptor bitmapDescriptor &#x3D; mLruCache.get(num);</span><br><span class="line">        if (bitmapDescriptor &#x3D;&#x3D; null) &#123;</span><br><span class="line">            TextView textView &#x3D; new TextView(mContext);</span><br><span class="line">            &#x2F;&#x2F; 应用字体</span><br><span class="line">            textView.setTypeface(typeFace);</span><br><span class="line">            if (num &lt; 10) &#123;</span><br><span class="line">                String tile &#x3D; String.valueOf(num);</span><br><span class="line"></span><br><span class="line">                textView.setText(tile);</span><br><span class="line">            &#125;else if(num&#x3D;&#x3D;1)&#123;</span><br><span class="line">                textView.setText(&quot;&quot;);</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                float zoom &#x3D; mAMap.getCameraPosition().zoom;</span><br><span class="line">                &#x2F;&#x2F;loge(&quot;当前缩放级别是&#x3D;&#x3D;&quot; + zoom);</span><br><span class="line">                if (zoom &#x3D;&#x3D; 19.0 || zoom &#x3D;&#x3D; 20.0) &#123;</span><br><span class="line">                    String tile &#x3D; String.valueOf(num);</span><br><span class="line">                    textView.setText(tile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            textView.setGravity(Gravity.CENTER);</span><br><span class="line">            textView.setTextColor(Color.parseColor(&quot;#ffffff&quot;));</span><br><span class="line">            textView.setTextSize(TypedValue.COMPLEX_UNIT_SP, 12);</span><br><span class="line">            if (mClusterRender !&#x3D; null &amp;&amp; mClusterRender.getDrawAble(num) !&#x3D; null) &#123;</span><br><span class="line">                textView.setBackgroundDrawable(mClusterRender.getDrawAble(num));   &#x2F;&#x2F;根据数量设置背景样式</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F;textView.setBackgroundResource(R.mipmap.act_map_evelopetwo);</span><br><span class="line">                &#x2F;&#x2F;2017&#x2F;09&#x2F;25修改 换图标</span><br><span class="line">                textView.setBackgroundResource(R.mipmap.act_map_blue_icon_bg);</span><br><span class="line">            &#125;</span><br><span class="line">            bitmapDescriptor &#x3D; BitmapDescriptorFactory.fromView(textView);</span><br><span class="line">            mLruCache.put(num, bitmapDescriptor);    &#x2F;&#x2F;把聚合点数量,样式键值对形式存入集合中</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        return bitmapDescriptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 更新已加入地图聚合点的样式</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private void updateCluster(Cluster cluster) &#123;</span><br><span class="line"></span><br><span class="line">        Marker marker &#x3D; cluster.getMarker();</span><br><span class="line">        marker.setIcon(getBitmapDes(cluster.getClusterCount()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;-----------------------辅助内部类用---------------------------------------------</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * marker渐变动画，动画结束后将Marker删除</span><br><span class="line">     *&#x2F;</span><br><span class="line">    class MyAnimationListener implements Animation.AnimationListener &#123;</span><br><span class="line">        private List&lt;Marker&gt; mRemoveMarkers;</span><br><span class="line"></span><br><span class="line">        MyAnimationListener(List&lt;Marker&gt; removeMarkers) &#123;</span><br><span class="line">            mRemoveMarkers &#x3D; removeMarkers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onAnimationStart() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onAnimationEnd() &#123;</span><br><span class="line">            for (Marker marker : mRemoveMarkers) &#123;</span><br><span class="line">                marker.remove();</span><br><span class="line">            &#125;</span><br><span class="line">            mRemoveMarkers.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 处理market添加，更新等操作</span><br><span class="line">     *&#x2F;</span><br><span class="line">    class MarkerHandler extends Handler &#123;</span><br><span class="line"></span><br><span class="line">        static final int ADD_CLUSTER_LIST &#x3D; 0;</span><br><span class="line"></span><br><span class="line">        static final int ADD_SINGLE_CLUSTER &#x3D; 1;</span><br><span class="line"></span><br><span class="line">        static final int UPDATE_SINGLE_CLUSTER &#x3D; 2;</span><br><span class="line"></span><br><span class="line">        MarkerHandler(Looper looper) &#123;</span><br><span class="line">            super(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void handleMessage(Message message) &#123;</span><br><span class="line"></span><br><span class="line">            switch (message.what) &#123;</span><br><span class="line">                case ADD_CLUSTER_LIST:</span><br><span class="line">                    List&lt;Cluster&gt; clusters &#x3D; (List&lt;Cluster&gt;) message.obj;</span><br><span class="line">                    addClusterToMap(clusters);</span><br><span class="line">                    break;</span><br><span class="line">                case ADD_SINGLE_CLUSTER:</span><br><span class="line">                    Cluster cluster &#x3D; (Cluster) message.obj;</span><br><span class="line">                    addSingleClusterToMap(cluster);</span><br><span class="line">                    break;</span><br><span class="line">                case UPDATE_SINGLE_CLUSTER:</span><br><span class="line">                    Cluster updateCluster &#x3D; (Cluster) message.obj;</span><br><span class="line">                    updateCluster(updateCluster);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 处理聚合点算法线程</span><br><span class="line">     *&#x2F;</span><br><span class="line">    class SignClusterHandler extends Handler &#123;</span><br><span class="line">        static final int CALCULATE_CLUSTER &#x3D; 0;</span><br><span class="line">        static final int CALCULATE_SINGLE_CLUSTER &#x3D; 1;</span><br><span class="line"></span><br><span class="line">        SignClusterHandler(Looper looper) &#123;</span><br><span class="line">            super(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void handleMessage(Message message) &#123;</span><br><span class="line">            switch (message.what) &#123;</span><br><span class="line">                case CALCULATE_CLUSTER:</span><br><span class="line">                    calculateClusters();</span><br><span class="line">                    break;</span><br><span class="line">                case CALCULATE_SINGLE_CLUSTER:</span><br><span class="line">                    ClusterItem item &#x3D; (ClusterItem) message.obj;</span><br><span class="line">                    mClusterItems.add(item);</span><br><span class="line">                    Log.e(&quot;cluster_overlay&quot;, &quot;calculate single cluster&quot;);</span><br><span class="line">                    calculateSingleCluster(item);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码大家可以根据自己具体需要修改,接下来是聚合标签类Cluster代码,几乎没改(滑稽):</p>
<blockquote>
<p>Cluster:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class Cluster &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private LatLng mLatLng;</span><br><span class="line">    private List&lt;ClusterItem&gt; mClusterItems;</span><br><span class="line">    private Marker mMarker;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public Cluster(LatLng latLng) &#123;</span><br><span class="line"></span><br><span class="line">        mLatLng &#x3D; latLng;</span><br><span class="line">        mClusterItems &#x3D; new ArrayList&lt;ClusterItem&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Cluster(List&lt;ClusterItem&gt; clusterItems)&#123;</span><br><span class="line">        mClusterItems &#x3D; new ArrayList&lt;&gt;() ;</span><br><span class="line">        mClusterItems &#x3D; clusterItems;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void addClusterItem(ClusterItem clusterItem) &#123;</span><br><span class="line">        mClusterItems.add(clusterItem);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getClusterCount() &#123;</span><br><span class="line">        return mClusterItems.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public LatLng getCenterLatLng() &#123;</span><br><span class="line">        return mLatLng;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMarker(Marker marker) &#123;</span><br><span class="line">        mMarker &#x3D; marker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Marker getMarker() &#123;</span><br><span class="line">        return mMarker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;ClusterItem&gt; getClusterItems() &#123;</span><br><span class="line">        return mClusterItems;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是ClusterItem接口了,用来获取聚合标签的相关信息:</p>
<blockquote>
<p>ClusterItem:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface ClusterItem &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 返回聚合元素的地理位置</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    LatLng getPosition();</span><br><span class="line">    String getUserType();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有人可能会问:getUserType()方法干啥用的?客官,别急,先接着往下看,很快就知道它的用处了.</p>
<p>接着,就是我们的RegionItem类了,实现了ClusterItem接口:</p>
<blockquote>
<p>RegionItem:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class RegionItem implements ClusterItem &#123;</span><br><span class="line">    private LatLng mLatLng;</span><br><span class="line">    private String userType;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public String getUserType() &#123;</span><br><span class="line">        return userType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RegionItem(LatLng latLng, String userType) &#123;</span><br><span class="line">        this.mLatLng&#x3D;latLng;</span><br><span class="line">        this.userType &#x3D; userType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public LatLng getPosition() &#123;</span><br><span class="line">        &#x2F;&#x2F; TODO Auto-generated method stub</span><br><span class="line">        return mLatLng;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后,就是要在Activity中根据需求添加我们的聚合标签了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">private ClusterOverlay mClusterOverlay;&#x2F;&#x2F;普通用户聚合覆盖物的对象</span><br><span class="line">private BClusterOverlay bClusterOverlay;&#x2F;&#x2F;企业用户聚合覆盖物的对象</span><br><span class="line">&#x2F;**</span><br><span class="line">     * by moos on 2017&#x2F;11&#x2F;15</span><br><span class="line">     * func:添加并显示聚合点,增加点击和绘制事件</span><br><span class="line">     *&#x2F;</span><br><span class="line">    </span><br><span class="line">    private void addItems() &#123;</span><br><span class="line">        new Thread() &#123;</span><br><span class="line">            public void run() &#123;</span><br><span class="line"></span><br><span class="line">                List&lt;ClusterItem&gt; items &#x3D; new ArrayList&lt;ClusterItem&gt;();&#x2F;&#x2F;普通用户</span><br><span class="line">               </span><br><span class="line">                List&lt;ClusterItem&gt; bItems &#x3D; new ArrayList&lt;ClusterItem&gt;();&#x2F;&#x2F;企业用户</span><br><span class="line">            </span><br><span class="line">                 &#x2F;&#x2F;loge(&quot;附近的点有&#x3D;&#x3D;&#x3D;&quot; + imageNearBean.getData().getExhibitionList().size());</span><br><span class="line">                for (int i &#x3D; 0; i &lt; imageNearBean.getData().getExhibitionList().size(); i++) &#123;</span><br><span class="line"></span><br><span class="line">                    double lat &#x3D; imageNearBean.getData().getExhibitionList().get(i).getLatitude();</span><br><span class="line">                    double lon &#x3D; imageNearBean.getData().getExhibitionList().get(i).getLongitude();</span><br><span class="line"></span><br><span class="line">                    if (imageNearBean.getData().getExhibitionList().get(i).getUserType() !&#x3D; null &amp;&amp;</span><br><span class="line">                            imageNearBean.getData().getExhibitionList().get(i).getUserType().equals(&quot;03&quot;)) &#123;&#x2F;&#x2F;是企业用户的数据</span><br><span class="line">                        LatLng latLng &#x3D; new LatLng(lat, lon, false);</span><br><span class="line">                        RegionItem regionItem &#x3D; new RegionItem(latLng,  imageNearBean.getData().getExhibitionList().get(i).getUserType());&#x2F;&#x2F;添加元素</span><br><span class="line">                        bItems.add(regionItem);</span><br><span class="line">                        allBussinessBean.add(imageNearBean.getData().getExhibitionList().get(i));&#x2F;&#x2F;放入所有企业用户数据</span><br><span class="line">                    &#125;else &#123; &#x2F;&#x2F;是普通用户</span><br><span class="line">                        LatLng latLng &#x3D; new LatLng(lat, lon, false);</span><br><span class="line">                        RegionItem regionItem &#x3D; new RegionItem(latLng, imageNearBean.getData().getExhibitionList().get(i).getOriginalId(), imageNearBean.getData().getExhibitionList().get(i).getUserType());&#x2F;&#x2F;添加元素</span><br><span class="line">                        items.add(regionItem);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                log.e(&quot;普通用户有&#x3D;&#x3D;&quot; + items.size());</span><br><span class="line">                log.e(&quot;企业用户有&#x3D;&#x3D;&quot; + bItems.size());</span><br><span class="line"></span><br><span class="line">                if ( items.size() &gt; 0) &#123;</span><br><span class="line">    </span><br><span class="line">                    if (mClusterOverlay &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        &#x2F;&#x2F;覆盖物的集合,</span><br><span class="line">                        mClusterOverlay &#x3D; new ClusterOverlay(mAMap, items, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());   &#x2F;&#x2F;地图对象,集合,聚合范围,上下文传到指定方法实现</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        mClusterOverlay.onDestroy();   &#x2F;&#x2F;销毁之前的覆盖物集合</span><br><span class="line">                        mClusterOverlay &#x3D; null;</span><br><span class="line">                        mClusterOverlay &#x3D; new ClusterOverlay(mAMap, items, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F;渲染和聚合点点击事件监听</span><br><span class="line">                    mClusterOverlay.setClusterRenderer(MapActivity.this);      &#x2F;&#x2F;getdrawable 方法实现</span><br><span class="line">                    mClusterOverlay.setOnClusterClickListener(MapActivity.this);    &#x2F;&#x2F;onclick方法实现</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                if (  bItems.size() &gt; 0) &#123;</span><br><span class="line">                    &#x2F;&#x2F;商家用户数据</span><br><span class="line">                    loge(&quot;设置企业标签点击事件&quot;);</span><br><span class="line">                    if (bClusterOverlay &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        &#x2F;&#x2F;覆盖物的集合</span><br><span class="line">                        bClusterOverlay &#x3D; new BClusterOverlay(mAMap, bItems, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        bClusterOverlay.onDestroy();</span><br><span class="line">                        bClusterOverlay &#x3D; null;</span><br><span class="line">                        bClusterOverlay &#x3D; new BClusterOverlay(mAMap, bItems, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F;渲染和聚合点点击事件监听</span><br><span class="line">                    bClusterOverlay.setClusterRenderer(this);</span><br><span class="line">                    bClusterOverlay.setOnClusterClickListener(MapActivity.this);    &#x2F;&#x2F;onBclick 方法实现</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                runOnUiThread(new Runnable() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void run() &#123;</span><br><span class="line">                        addMarkersToMap();&#x2F;&#x2F;添加普通marker到地图</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里大家可能看得很烦,没错,看得很烦就对了😆!因为这一部分完全没必要看…只是为了筛选后台不同的用户数据而已。记得之前我提到的ClusterItem类中getUserType()方法以及实现这个接口的类RegionItem中定义的userType变量吗?它的作用就是用来区分不同的聚合标签,以上代码的03代表商家用户,其余类型默认普通用户。</p>
<p>最后,就是我们的重头戏了,集中处理多种聚合标签的点击事件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">mAMap.setOnCameraChangeListener(new AMap.OnCameraChangeListener() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onCameraChange(CameraPosition cameraPosition) &#123;</span><br><span class="line">                    &#x2F;&#x2F;LatLng latLng &#x3D; cameraPosition.target;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onCameraChangeFinish(CameraPosition cameraPosition) &#123;</span><br><span class="line"></span><br><span class="line">                    mClusterOverlay.updateClusters();&#x2F;&#x2F;刷新</span><br><span class="line">                    bClusterOverlay.updateClusters();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            mAMap.setOnMarkerClickListener(new AMap.OnMarkerClickListener() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public boolean onMarkerClick(Marker marker) &#123;</span><br><span class="line">                    &#x2F;&#x2F;mClusterOverlay.cleanListener();</span><br><span class="line">                    Cluster cluster &#x3D; (Cluster) marker.getObject();</span><br><span class="line">                    if(cluster!&#x3D;null &amp;&amp; cluster.getClusterCount()&gt;0)&#123;</span><br><span class="line">                        if(cluster.getClusterItems().get(0).getUserType().equals(&quot;03&quot;))&#123;</span><br><span class="line">                            loge(&quot;是普通用户聚合标签&quot;);</span><br><span class="line">                            mClusterOverlay.respondClusterClickEvent(marker);&#x2F;&#x2F;响应聚合点的点击事件    </span><br><span class="line">                        &#125;else &#123;</span><br><span class="line">                            loge(&quot;是商家用户聚合标签&quot;);</span><br><span class="line">                            bClusterOverlay.respondClusterClickEvent(marker);&#x2F;&#x2F;响应聚合点的点击事件</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">            </span><br><span class="line">    &#x2F;&#x2F;聚合标签的点击事件</span><br><span class="line">    @Override</span><br><span class="line">    public void onClick(Marker marker, List&lt;ClusterItem&gt; clusterItems) &#123;</span><br><span class="line">        loge(&quot;点击了普通用户&quot;);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public void onBClick(Marker marker, List&lt;ClusterItem&gt; clusterItems) &#123;</span><br><span class="line">        loge(&quot;点击了商家用户&quot;);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>代码有点多,具体业务逻辑代码就不贴了,估计看了也会比较的烦,大家只需要看onMarkerClick()方法中的逻辑就OK了。一般情况下,我们需要点击不同的marker后,获取该marker应该对应的数据,那么该如何获取呢?为了快点结束战斗,这里我就不卖关子了,高德marker类中有一方法getObject(),官方是这样描述的:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5256969-0d434a7340359c3f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="获取marker附加信息"></p>
<p>看到这,很多人一定豁然开朗,没错!还有个对应的方法marker.setObject(Object obj)。在ClusterOverlay中,我们可以找到如下代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 将单个聚合元素添加至地图显示</span><br><span class="line">     *</span><br><span class="line">     * @param cluster</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private void addSingleClusterToMap(Cluster cluster) &#123;</span><br><span class="line">        latlng1 &#x3D; cluster.getCenterLatLng();</span><br><span class="line">        markerOptions &#x3D; new MarkerOptions();</span><br><span class="line">        markerOptions</span><br><span class="line">                .anchor(0.5f, 0.5f)</span><br><span class="line">                .icon(getBitmapDes(cluster.getClusterCount()))</span><br><span class="line">                .position(latlng1);</span><br><span class="line">        Marker marker &#x3D; mAMap.addMarker(markerOptions);</span><br><span class="line">        marker.setAnimation(mADDAnimation);</span><br><span class="line">        marker.setObject(cluster);</span><br><span class="line">        marker.startAnimation();</span><br><span class="line">        cluster.setMarker(marker);</span><br><span class="line">        mcluster &#x3D; cluster;</span><br><span class="line">        mAddMarkers.add(marker);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>看看上面这块代码,我们的确发现了marker.setObject(cluster)方法,cluster里面有什么?有ClusterItem呀!看到这,我们就发现,前面的getUsertype()方法不是正好派上用场了嘛!添加聚合标签的时候,我们给每个marker贴上了”名牌”,当我们点击聚合标签的时候,拿到附加的信息并找到这个名牌(userType),这样不就可以轻而易举”撕掉名牌”了吗!😆</p>
<p>&emsp;&emsp;这样我们就解决多种聚合标签点击冲突的问题了,至于如何解决聚合标签与普通Marker点击事件冲突,其实大同小异,这里就不献丑了,相信对于大家来说没什么问题。下一篇文章将为大家提供marker加载网络图片的完美解决方案,请拭目以待!</p>
<p>&emsp;&emsp;最后,大家有任何问题或者建议,欢迎留言或者加群讨论,谢谢.</p>
<blockquote>
<p>代码地址：<a href="https://github.com/Moosphan/AMapMarker-master">https://github.com/Moosphan/AMapMarker-master</a></p>
</blockquote>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE/">高德地图</a><a class="link-muted mr-2" rel="tag" href="/tags/Marker%E8%81%9A%E5%90%88/">Marker聚合</a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><div class="social-share"></div><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2017/11/25/amap-marker-custom/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">基于高德地图实现完全自定义Marker</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2017/09/24/amap-input-tips/"><span class="level-item">Android基于高德地图实现搜索框的自动输入提示功能</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.6.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: 'e30e18bd50be9537e12c3baa1cec0052',
            repo: 'Moosphan.github.io',
            owner: 'Moosphan',
            clientID: 'dc647e1369a56ca7d0ca',
            clientSecret: '31a92ba8e7783a092d0dee1b591657b0afa9c931',
            admin: "Moosphan",
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            
            
            enableHotKey: true
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">11</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/Android/Architecture/"><span class="level-start"><span class="level-item">Architecture</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Android/Proguard/"><span class="level-start"><span class="level-item">Proguard</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Android/%E5%8A%A8%E7%94%BB/"><span class="level-start"><span class="level-item">动画</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Android/%E5%9C%B0%E5%9B%BE%E5%BC%80%E5%8F%91/"><span class="level-start"><span class="level-item">地图开发</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Android/%E5%BC%80%E6%BA%90/"><span class="level-start"><span class="level-item">开源</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/Android-Gradle/"><span class="level-start"><span class="level-item">Android Gradle</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Flutter/"><span class="level-start"><span class="level-item">Flutter</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/Flutter/Dart/"><span class="level-start"><span class="level-item">Dart</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/Google/"><span class="level-start"><span class="level-item">Google</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/Google/Meeting/"><span class="level-start"><span class="level-item">Meeting</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/Jcenter/"><span class="level-start"><span class="level-item">Jcenter</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Mac/"><span class="level-start"><span class="level-item">Mac</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">个人总结</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E6%B8%B8%E6%88%8F/"><span class="level-start"><span class="level-item">微信小游戏</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-architecture/"><span class="tag">Android architecture</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-tools/"><span class="tag">Android tools</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-%E5%8A%A8%E7%94%BB/"><span class="tag">Android 动画</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Anko/"><span class="tag">Anko</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AppBar/"><span class="tag">AppBar</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ConstraintLayout/"><span class="tag">ConstraintLayout</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dart/"><span class="tag">Dart</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Flutter/"><span class="tag">Flutter</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Google/"><span class="tag">Google</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Google-develop-days/"><span class="tag">Google develop days</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Gradle/"><span class="tag">Gradle</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Image-selector/"><span class="tag">Image selector</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jcenter/"><span class="tag">Jcenter</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kotlin/"><span class="tag">Kotlin</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Layabox/"><span class="tag">Layabox</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MVP/"><span class="tag">MVP</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mac/"><span class="tag">Mac</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Marker%E8%81%9A%E5%90%88/"><span class="tag">Marker聚合</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MotionLayout/"><span class="tag">MotionLayout</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Proguard/"><span class="tag">Proguard</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell%E8%84%9A%E6%9C%AC/"><span class="tag">Shell脚本</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/UI%E6%95%88%E6%9E%9C/"><span class="tag">UI效果</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9C%B0%E5%9B%BE%E5%AF%BC%E8%88%AA/"><span class="tag">地图导航</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B1%95%E4%BC%9A/"><span class="tag">展会</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87/"><span class="tag">开发效率</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E6%BA%90/"><span class="tag">开源</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E6%B8%B8%E6%88%8F/"><span class="tag">微信小游戏</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"><span class="tag">快捷键</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%BB%E7%BB%93/"><span class="tag">总结</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9C%AA%E6%9D%A5%E8%A7%84%E5%88%92/"><span class="tag">未来规划</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B8%E6%88%8F%E6%8E%92%E8%A1%8C%E6%A6%9C/"><span class="tag">游戏排行榜</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%B8%E6%88%8F%E8%84%9A%E6%9C%AC/"><span class="tag">游戏脚本</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89Marker/"><span class="tag">自定义Marker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%84%E8%AE%BA%E5%9B%9E%E5%A4%8D/"><span class="tag">评论回复</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%BB%E4%B9%A6/"><span class="tag">读书</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BE%93%E5%85%A5%E6%8F%90%E7%A4%BA/"><span class="tag">输入提示</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE/"><span class="tag">高德地图</span><span class="tag is-grey-lightest">4</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Hulk" height="28"></a><p class="size-small"><span>&copy; 2020 Hulk</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Moosphan"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://moosphan.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>